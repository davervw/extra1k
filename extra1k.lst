; EXTRA1K.LST - Dump and Disassembly
;
; EXTRA1K.PRG - make 1K extra RAM available for BASIC
;
; Copyright (c) 2025 by David R. Van Wagner
; MIT LICENSE
;
; https://github.com/davervw/extra1k
;
; Moves BASIC RAM low pointer to $400 (1024)
; Moves Screen to $CC00
; Copies CHAR ROM $D000 to $F000 RAM (otherwise CHAR ROM is unavailable to VIC-II in bank 3)
; Handler code $CBA3 to $CBFF
;
; INSTRUCTIONS:
;    LOAD "EXTRA1K",8,1
;    SYS 52131
;
; WARNING: 
;    $CBA3 to $CFFF is reserved, and screen memory has moved to 52224
;    May not be compatible as is with other BASIC extensions 
;      because of new NMI handler used to keep changes from being reverted
;
; CREDITS: 
;   8-Bit Show And Tell (SYS 58266 = JMP E39A) https://youtu.be/WZQ1FMWnG9w
;   C64 RAM banks discussion https://techwithdave.davevw.com/2024/06/banktest-for-c64.html
;   CBM BASIC ROM NMI Handler (JMP E38B, JMP A474)
;   Jim Butterfield's SCREENMAP64 for calculating POKEs to move screen/chars
;   Ultimate Commodore 64 Reference: ROM Disassembly https://www.pagetable.com/c64ref/c64disasm
;   Compute!'s Mapping the Commodore 64 https://archive.org/details/Compute_s_Mapping_the_Commodore_64
;   Programmed in VICE 3.8 monitor

; cba3 = 52131

>C:cba3  78 a0 00 84  fb a9 d0 85  fc a5 01 aa  29 f9 85 01
>C:cbb3  84 fd a9 f0  85 fe b1 fb  91 fd c8 d0  f9 e6 fc e6
>C:cbc3  fe d0 f3 86  01 58 8c 00  04 a9 04 85  2c a9 f5 a2
>C:cbd3  cb 8d 00 03  8e 01 03 20  e0 cb 4c 9a  e3 a9 04 8d
>C:cbe3  00 dd a9 3c  8d 18 d0 a9  cc 8d 88 02  60 8a 10 06
>C:cbf3  20 e0 cb 4c  8b e3 4c 74  a4 ea ea ea  ea         

.C:cba3  78          SEI
.C:cba4  A0 00       LDY #$00
.C:cba6  84 FB       STY $FB
.C:cba8  A9 D0       LDA #$D0
.C:cbaa  85 FC       STA $FC
.C:cbac  A5 01       LDA $01
.C:cbae  AA          TAX
.C:cbaf  29 F9       AND #$F9
.C:cbb1  85 01       STA $01
.C:cbb3  84 FD       STY $FD
.C:cbb5  A9 F0       LDA #$F0
.C:cbb7  85 FE       STA $FE
.C:cbb9  B1 FB       LDA ($FB),Y
.C:cbbb  91 FD       STA ($FD),Y
.C:cbbd  C8          INY
.C:cbbe  D0 F9       BNE $CBB9
.C:cbc0  E6 FC       INC $FC
.C:cbc2  E6 FE       INC $FE
.C:cbc4  D0 F3       BNE $CBB9
.C:cbc6  86 01       STX $01
.C:cbc8  58          CLI
.C:cbc9  8C 00 04    STY $0400
.C:cbcc  A9 04       LDA #$04
.C:cbce  85 2C       STA $2C
.C:cbd0  A9 F0       LDA #$F0
.C:cbd2  A2 CB       LDX #$CB
.C:cbd4  8D 00 03    STA $0300
.C:cbd7  8E 01 03    STX $0301
.C:cbda  20 E0 CB    JSR $CBE0
.C:cbdd  4C 9A E3    JMP $E39A
.C:cbe0  A9 04       LDA #$04
.C:cbe2  8D 00 DD    STA $DD00
.C:cbe5  A9 3C       LDA #$3C
.C:cbe7  8D 18 D0    STA $D018
.C:cbea  A9 CC       LDA #$CC
.C:cbec  8D 88 02    STA $0288
.C:cbef  60          RTS
.C:cbf0  8A          TXA
.C:cbf1  10 06       BPL $CBF9
.C:cbf3  20 E0 CB    JSR $CBE0
.C:cbf6  4C 91 E3    JMP $E391
.C:cbf9  4C 8E E3    JMP $E38E
.C:cbfc  EA          NOP
.C:cbfd  EA          NOP
.C:cbfe  EA          NOP
.C:cbff  EA          NOP
